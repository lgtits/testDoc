import{C as h,Q as ve,_ as me,p as ge,a as he}from"./promptLangOptions.3f67ce17.js";import{_ as fe,d as ye,k as be,r as n,h as we,i as Ce,a as m,S as Te,l as ke,be as Ae,o as l,e as r,g as a,n as N,t as g,q as v,y as I,f as u,x as L,u as y,bj as Ee,F as b,aH as R,w as z,s as ee,p as V,a$ as Me,bh as Oe,aO as se,bi as Ne,b3 as Ie,aI as Re,aJ as De}from"./index.012de2e5.js";import{Q as Be}from"./QSelect.c9663a0a.js";import{F as j}from"./Format.45ca4c10.js";import{N as Se}from"./Notify.bbd61ef5.js";import{D as He}from"./Dialog.271766ad.js";import"./index.f0afc0c8.js";import"./QItemSection.4b2bcfa2.js";import"./QItemLabel.b5c610c6.js";import"./format.60d2887c.js";const $e=D=>(Re("data-v-417f943a"),D=D(),De(),D),Pe={key:0,class:"chatbot-page"},xe={class:"chatbot-header"},Ue={class:"title"},qe={key:0,class:"routes"},Fe={class:"header-title q-mb-sm row justify-between"},Le={class:"row toggle-wrapper"},ze={key:0,class:"toggle-on-demand"},Ve={class:"route-wrapper row justify-between"},je={class:""},Qe={class:"route-index q-mr-sm"},Ge={class:"nodes row items-center"},We=["onClick"],Je={key:0,class:"q-mx-xs"},Ke={class:"btn"},Xe={key:0,class:"apply-button"},Ye={class:"chatbot-page__message-area column"},Ze=$e(()=>a("div",{class:"sidebar-title q-mb-sm"},"References:",-1)),es={class:"sources q-ml-sm column"},ss={href:"",class:""},ts={class:"q-mr-xs icon-wrapper"},as=["href"],os={class:"report-button"},ls={key:0,class:"message user-message"},ns={key:1,class:"row items-center justify-end"},rs={class:"q-ml-xs text-negative"},is={key:2,class:"message"},cs={class:"chatbot-footer"},us={key:0,class:"lang-select row justify-end"},ds={class:"chatbot-footer__content"},_s={class:"chatbot-footer__content__input row w-100 full-width justify-between items-center"},ps=["placeholder","onKeydown"],vs=ye({__name:"OnlineChatbotPageDir",setup(D){const{t:te,locale:Q}=be(),ae=n(!1),f=n(),A=n(),G=n(!1),W=n(""),_=n(""),oe=we(),B=Ce(()=>oe.params.bookcaseId.toString()),le=n(),d=n(),$=n(),E=n(),P=n(!1),w=n(!0),J=n(),C=n([]),x=n([]),S=n(""),U=n(m.BUILD_CHATBOT_TEXTAREA_LANGUAGE),M=n(),H=n(!0),T=n(m.RUNTIME_EXPAND_CHATBOT_DATA_SCOPE_MENU&&m.RUNTIME_ENABLE_CHATBOT_DATA_SCOPE_MODIFICATION),q=n(m.RUNTIME_ENABLE_CHATBOT_DATA_SCOPE_MODIFICATION),K=()=>{q.value&&(T.value=!T.value)},O=async s=>{if(!w.value)return;$.value=s,_.value="",P.value=!0,w.value=!1;const e=C.value.join(",");try{const o=await h.postMessage(le.value,e,{message:s,history:d.value},U.value);d.value=o,P.value=!1,E.value=""}catch(o){E.value=o.message||"Error"}finally{w.value=!0}A.value.scrollTop=A.value.scrollHeight},ne=async s=>{const e=await h.getRecommendPrompts(s);J.value=e.result.recommend_prompts},re=async s=>{const e=await h.getHistoryMessages(s);d.value=e.result.history_messages,W.value=e.result.page_title},ie=async s=>{if(m.RUNTIME_SHOW_CHATBOT_DATA_SCOPE_REFERENCES){S.value=s;const e=await h.getReferences(s);x.value=e.result.references}},ce=async()=>{C.value=[B.value];const e=(await h.getDirectories(B.value)).result.data;M.value=h.processDirectories(e)},X=async()=>{C.value=[],M.value?.forEach(s=>{let e=s.nodes.find(o=>o.selected===!0);e&&C.value.push(e.id)}),C.value.length||(C.value=[B.value])},ue=async(s,e,o)=>{o||(M.value=M.value?.map((i,t)=>{if(t===s){let p=!1,c=!1,k=!1;return{...i,nodes:i.nodes.map((F,Z)=>(Z===e&&(p=!0,c=!F.selected),p&&Z>e&&(k=c),{...F,selected:c,prevNodeSelected:k}))}}return i}),H.value&&(X(),await de()))};Te(()=>_.value,s=>{f.value.style.height="25px";const e=m.RUNTIME_CHATBOT_TEXTAREA_HEIGHT;if(s){if(f.value.clientHeight>=e)return;const o=f.value.scrollHeight>=e?e:f.value.scrollHeight;f.value.style.height="25px",f.value.style.height=o+"px"}});const de=async()=>{console.log("resend request");let s="";for(let o=d.value.length-1;o>=0;o--){const i=d.value[o]?.[0];if(i){const t=i.replace(/'/g,'"');s=JSON.parse(t)[0];break}}const e=o=>{for(let i=o.length-1;i>=0;i--)if(o[i][0]!==null)return o.slice(0,i);return o};d.value=e(d.value),await O(s)},_e=()=>{if(!_.value)for(let s=d.value.length-1;s>=0;s--){const e=d.value[s]?.[0];if(e){const o=e.replace(/'/g,'"'),t=JSON.parse(o)[0];_.value=t;return}}},Y=async s=>{console.log("page init: ",s),await ce(),await re(s),await ne(Q.value),G.value=!0},pe=s=>{console.log("report: ",s),He.confirm({title:Q.value==="zh"?"\u60A8\u5C0D\u9019\u500B\u56DE\u7B54\u4E0D\u6EFF\u610F\u55CE\uFF1F":"Are you dissatisfied with this answer?",message:"",onOk:async()=>{const e=await h.reportBadResponse(s);console.log(e),Se.error(te("$i18n_Reported_$i18n"))}})};return ke(async()=>{await h.initAppClient(),await Y(B.value),A.value.scrollTop=A.value.scrollHeight}),Ae(async(s,e,o)=>{o(),await Y(s.params.bookcaseId.toString())}),(s,e)=>{const o=he,i=me;return G.value?(l(),r("div",Pe,[a("div",xe,[a("div",{class:N(["document-title row justify-center items-center",{"q-mb-sm":T.value}])},[a("span",Ue,g(W.value),1),!T.value&&q.value?(l(),r("div",{key:0,class:"row expand-scope items-center cursor-pointer",onClick:K},[v(I,{name:"sym_o_expand_circle_down",class:"",size:"sm"})])):u("",!0)],2),T.value?(l(),r("div",qe,[a("div",Fe,[L(g(s.$t("$i18n_RAG_data_scope_$i18n"))+": ",1),a("div",Le,[y(m).RUNTIME_ENABLE_CHATBOT_DATA_SCOPE_ON_DEMAND?(l(),r("div",ze,[v(Ee,{modelValue:H.value,"onUpdate:modelValue":e[0]||(e[0]=t=>H.value=t),label:`On-demand ${s.$t("$i18n_Mode_$i18n")}`,"left-label":"",color:"indigo-7",disabled:""},null,8,["modelValue","label"])])):u("",!0),T.value&&q.value?(l(),r("div",{key:1,class:"row items-center cursor-pointer expand-btn-wrapper",onClick:K},[v(I,{name:"sym_o_expand_circle_up",class:"q-mr-sm",size:"sm"})])):u("",!0)])]),a("div",Ve,[a("div",je,[(l(!0),r(b,null,R(M.value,(t,p)=>(l(),r("div",{class:"route row items-center q-mb-sm",key:t.id},[a("div",Qe,g(t.id)+".",1),a("div",Ge,[(l(!0),r(b,null,R(t.nodes,(c,k)=>(l(),r(b,{key:c.id},[a("div",{class:N(["node",{active:c.selected,disabled:c.prevNodeSelected}]),onClick:F=>ue(p,k,c.prevNodeSelected)},g(c.name),11,We),k<t.nodes.length-1?(l(),r("div",Je," / ")):u("",!0)],64))),128))])]))),128))]),a("div",Ke,[H.value?u("",!0):(l(),r("div",Xe,[v(ee,{style:{background:"#3e52b5",color:"white"},push:"",size:"md",onClick:X},{default:z(()=>[L(g(s.$t("$i18n_APPLY_$i18n")),1)]),_:1})]))])])])):u("",!0)]),a("div",Ye,[x.value.length?(l(),r("div",{key:0,class:N(["chatbot-page__sidebar customized-scrollbar column justify-between",{collapse:ae.value}])},[Ze,a("div",es,[(l(!0),r(b,null,R(x.value,(t,p)=>(l(),r("div",{class:"source",key:t.referenceId},[a("a",ss,[a("span",ts," ["+g(p+1)+"] ",1),a("a",{href:t.url,target:"_blank",class:"origin-name"},g(t.name),9,as)])]))),128))]),a("div",os,[v(ee,{icon:"report",color:"primary",label:"Bad Response",onClick:e[1]||(e[1]=t=>pe(S.value))})])],2)):u("",!0),a("div",{class:"chatbot-message-wrapper customized-scrollbar column",ref_key:"messageWrapper",ref:A},[(l(!0),r(b,null,R(d.value,t=>(l(),r(b,{key:t},[(l(!0),r(b,null,R(t,(p,c)=>(l(),V(o,{key:p,message:p,role:c===0?"user":c===1?"bot":"id",messageId:y(j).getChatbotResponseId(t[1]),selectedMessage:!!(S.value&&y(j).getChatbotResponseId(t[1])===S.value&&c===1),onClick:k=>ie(y(j).getChatbotResponseId(t[1]))},null,8,["message","role","messageId","selectedMessage","onClick"]))),128))],64))),128)),P.value?(l(),r("div",ls,[L(g($.value)+" ",1),E.value?(l(),V(I,{key:0,class:"restart-btn",name:"sym_o_restart_alt",size:"md",onClick:e[2]||(e[2]=t=>O($.value))})):u("",!0)])):u("",!0),E.value?(l(),r("div",ns,[v(I,{name:"sym_o_error",color:"negative"}),a("span",rs,g(E.value),1)])):u("",!0),w.value?u("",!0):(l(),r("div",is,[v(ve,{color:"primary",size:"2em"})]))],512),!d.value.length&&y(m).RUNTIME_SHOW_CHATBOT_RECOMMEND_PROMPT?(l(),V(i,{key:1,options:J.value,onSubmitOption:O},null,8,["options"])):u("",!0),a("div",cs,[y(m).RUNTIME_SHOW_CHATBOT_PROMPT_LANGUAGE?(l(),r("div",us,[v(Be,{dense:"",borderless:"",modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=t=>U.value=t),options:y(ge),behavior:"menu","emit-value":""},{prepend:z(()=>[v(Ne,null,{default:z(()=>[v(I,{name:"sym_o_language",size:"sm"})]),_:1})]),_:1},8,["modelValue","options"])])):u("",!0),a("div",ds,[a("div",_s,[Me(a("textarea",{rows:"1",class:"customized-scrollbar",placeholder:s.$t("$i18n_Input_problem_$i18n"),ref_key:"textareaBlock",ref:f,"onUpdate:modelValue":e[4]||(e[4]=t=>_.value=t),onKeydown:[se(_e,["up"]),e[5]||(e[5]=se(Ie(t=>O(_.value),["alt"]),["enter"]))]},null,40,ps),[[Oe,_.value]]),a("div",{class:N(["submit-btn",{"cursor-pointer":_.value&&w.value}]),onClick:e[6]||(e[6]=t=>O(_.value))},[a("img",{src:"/images/icons/submit_btn.svg",alt:"",class:N({empty:!_.value||!w.value})},null,2)],2)])])])])])):u("",!0)}}});var As=fe(vs,[["__scopeId","data-v-417f943a"]]);export{As as default};
